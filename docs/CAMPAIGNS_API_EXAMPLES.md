# API de Campa√±as - Ejemplos para Frontend

## üéØ Capacidades del Sistema

El sistema de campa√±as te permite enviar mensajes por **WhatsApp**, **Email** o **Ambos** a:

‚úÖ **Todos los usuarios** del tenant  
‚úÖ **Asistentes de UNA reuni√≥n** espec√≠fica  
‚úÖ **Asistentes de M√öLTIPLES reuniones** (elimina duplicados autom√°ticamente)  
‚úÖ **Lista personalizada** de emails/tel√©fonos espec√≠ficos (contactos externos, VIPs, etc.)  

**Caracter√≠sticas:**
- Env√≠o inmediato o programado para fecha/hora futura
- Deduplicaci√≥n autom√°tica de destinatarios
- Tracking de env√≠o (pending, sent, failed)
- Contadores autom√°ticos de √©xito/fallos

---

## Endpoint Base
```
POST /campaigns
```

## Headers Requeridos
```
Authorization: Bearer {jwt_token}
Content-Type: application/json
Accept: application/json
```

---

## üìã Campos Disponibles

### Campos Obligatorios
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `title` | string (max 255) | T√≠tulo de la campa√±a |
| `message` | string (text) | Mensaje a enviar |
| `channel` | string (enum) | Canal de env√≠o: `"whatsapp"`, `"email"`, o `"both"` |

### Campos Opcionales
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `filter_json` | object | Filtros para segmentar destinatarios |
| `scheduled_at` | datetime | Fecha/hora programada (ISO 8601) - debe ser futura |

---

## üì® Ejemplos de Requests

### 1. Campa√±a Simple - Email Inmediato
Env√≠a un email a todos los usuarios inmediatamente.

```json
{
  "title": "Invitaci√≥n a Reuni√≥n Comunitaria",
  "message": "Te invitamos a participar en nuestra pr√≥xima reuni√≥n comunitaria este s√°bado 2 de noviembre a las 10:00 AM en la Casa Comunal.",
  "channel": "email"
}
```

**Nota:** Sin `filter_json` ni `scheduled_at`, se env√≠a inmediatamente a todos los usuarios del tenant.

---

### 2. Campa√±a WhatsApp Inmediata
Env√≠a WhatsApp a todos los usuarios inmediatamente.

```json
{
  "title": "Recordatorio Importante",
  "message": "Recordatorio: Ma√±ana reuni√≥n a las 10AM en Casa Comunal. Confirma tu asistencia.",
  "channel": "whatsapp"
}
```

---

### 3. Campa√±a Dual (Email + WhatsApp)
Env√≠a tanto por email como por WhatsApp.

```json
{
  "title": "Anuncio Urgente",
  "message": "Informaci√≥n importante: La reuni√≥n del viernes ha sido reprogramada para el lunes 4 de noviembre a las 3:00 PM.",
  "channel": "both"
}
```

**Comportamiento:**
- Si el usuario tiene email ‚Üí recibe email
- Si el usuario tiene tel√©fono ‚Üí recibe WhatsApp
- Si tiene ambos ‚Üí recibe por ambos canales

---

### 4. Campa√±a Programada
Programa el env√≠o para una fecha/hora espec√≠fica.

```json
{
  "title": "Recordatorio de Evento",
  "message": "Te recordamos que ma√±ana tenemos reuni√≥n. No faltes!",
  "channel": "both",
  "scheduled_at": "2025-11-03T08:00:00Z"
}
```

**Importante:**
- `scheduled_at` debe ser en formato ISO 8601
- La fecha debe ser futura (despu√©s de "now")
- Hora en UTC (ajustar timezone seg√∫n necesidad)

---

### 5. Campa√±a para Todos los Usuarios
Env√≠a a todos los usuarios del tenant.

```json
{
  "title": "Anuncio General",
  "message": "Les informamos sobre las nuevas actividades de la campa√±a pol√≠tica.",
  "channel": "email",
  "filter_json": {
    "target": "all_users"
  }
}
```

---

### 6. Campa√±a para Asistentes de UNA Reuni√≥n Espec√≠fica
Env√≠a solo a los asistentes registrados en una reuni√≥n.

```json
{
  "title": "Seguimiento Post-Reuni√≥n",
  "message": "Gracias por asistir a nuestra reuni√≥n. Aqu√≠ est√°n los compromisos acordados...",
  "channel": "email",
  "filter_json": {
    "target": "meeting_attendees",
    "meeting_ids": [15]
  }
}
```

**Uso com√∫n:**
- Enviar resumen de reuni√≥n
- Recordar compromisos adquiridos
- Encuestas post-evento
- Material de seguimiento

---

### 7. Campa√±a para Asistentes de M√öLTIPLES Reuniones
Env√≠a a todos los asistentes de varias reuniones (elimina duplicados autom√°ticamente).

```json
{
  "title": "Seguimiento Reuniones del Mes",
  "message": "Gracias por participar en nuestras reuniones este mes. Aqu√≠ el resumen de compromisos...",
  "channel": "email",
  "filter_json": {
    "target": "meeting_attendees",
    "meeting_ids": [15, 18, 20, 22]
  }
}
```

**Casos de uso:**
- Enviar resumen mensual a todos los participantes activos
- Campa√±a a asistentes de una serie de reuniones tem√°ticas
- Seguimiento a m√∫ltiples eventos relacionados
- Newsletter para participantes de varios sectores

---

### 8. Campa√±a a N√∫meros/Emails Espec√≠ficos (Lista Personalizada)
Env√≠a a una lista espec√≠fica de contactos individuales.

```json
{
  "title": "Invitaci√≥n Personalizada",
  "message": "Te invitamos a participar en nuestro evento especial...",
  "channel": "both",
  "filter_json": {
    "target": "custom_list",
    "custom_recipients": [
      {
        "type": "email",
        "value": "juan.perez@example.com",
        "name": "Juan P√©rez"
      },
      {
        "type": "phone",
        "value": "+573001234567",
        "name": "Mar√≠a Gonz√°lez"
      },
      {
        "type": "email",
        "value": "carlos.rodriguez@example.com",
        "name": "Carlos Rodr√≠guez"
      },
      {
        "type": "phone",
        "value": "+573009876543"
      }
    ]
  }
}
```

**Campos de `custom_recipients`:**
- `type` (obligatorio): `"email"` o `"phone"`
- `value` (obligatorio): Email o tel√©fono (con c√≥digo pa√≠s para WhatsApp)
- `name` (opcional): Nombre del destinatario

**Casos de uso:**
- Invitaciones VIP a l√≠deres espec√≠ficos
- Contactar personas que no est√°n registradas en el sistema
- Enviar a contactos externos (aliados, autoridades, etc.)
- Testing antes de enviar campa√±a masiva

---

### 9. Campa√±a Mixta: Asistentes + Lista Personalizada
**NOTA:** No es posible mezclar en una sola campa√±a. Debes crear 2 campa√±as separadas.

**Campa√±a 1 - Asistentes:**
```json
{
  "title": "Seguimiento Reuni√≥n",
  "message": "Gracias por asistir...",
  "channel": "email",
  "filter_json": {
    "target": "meeting_attendees",
    "meeting_ids": [15]
  }
}
```

**Campa√±a 2 - Invitados externos:**
```json
{
  "title": "Seguimiento Reuni√≥n",
  "message": "Gracias por asistir...",
  "channel": "email",
  "filter_json": {
    "target": "custom_list",
    "custom_recipients": [...]
  }
}
```

---

### 10. Campa√±a Programada para Asistentes
Combina filtro de asistentes + programaci√≥n.

```json
{
  "title": "Recordatorio Pre-Reuni√≥n",
  "message": "Ma√±ana es nuestra reuni√≥n. Te esperamos!",
  "channel": "whatsapp",
  "filter_json": {
    "target": "meeting_attendees",
    "meeting_ids": [20]
  },
  "scheduled_at": "2025-11-05T18:00:00Z"
}
```

**Caso de uso:** Enviar recordatorio 12-24 horas antes del evento.

---

### 11. Campa√±a con Mensaje Largo
Para emails con contenido extenso.

```json
{
  "title": "Resumen de Actividades del Mes",
  "message": "Estimados compa√±eros,\n\nLes compartimos el resumen de las actividades realizadas durante el mes:\n\n1. Reuniones comunitarias: 15\n2. Compromisos cumplidos: 45\n3. Nuevos afiliados: 120\n\nAgradecemos su participaci√≥n.\n\nSaludos,\nEquipo de Coordinaci√≥n",
  "channel": "email"
}
```

**Nota:** Usa `\n` para saltos de l√≠nea en el mensaje.

---

### 12. Campa√±a WhatsApp Corta (Recomendado)
Los mensajes de WhatsApp tienen mejor rendimiento cuando son concisos.

```json
{
  "title": "Alerta R√°pida",
  "message": "URGENTE: Cambio de ubicaci√≥n. Nueva direcci√≥n: Calle 50 #30-20. Confirma.",
  "channel": "whatsapp"
}
```

**Tip:** Mant√©n mensajes claros y concisos para mejor engagement.

---

## üìä Respuesta Exitosa (201 Created)

```json
{
  "data": {
    "id": 25,
    "tenant_id": 1,
    "title": "Invitaci√≥n a Reuni√≥n Comunitaria",
    "message": "Te invitamos a participar...",
    "channel": "email",
    "filter_json": {
      "target": "meeting_attendees",
      "meeting_id": 15
    },
    "scheduled_at": "2025-11-03T08:00:00.000000Z",
    "sent_at": null,
    "status": "pending",
    "total_recipients": 45,
    "sent_count": 0,
    "failed_count": 0,
    "created_by": 5,
    "creator": {
      "id": 5,
      "name": "Juan P√©rez",
      "email": "juan@example.com"
    },
    "created_at": "2025-10-30T12:00:00.000000Z",
    "updated_at": "2025-10-30T12:00:00.000000Z"
  },
  "message": "Campaign created and queued for sending"
}
```

---

## ‚ö†Ô∏è Validaciones y Errores

### Error 422 - Validation Error

#### T√≠tulo faltante
```json
{
  "message": "The title field is required.",
  "errors": {
    "title": ["The title field is required."]
  }
}
```

#### Mensaje faltante
```json
{
  "message": "The message field is required.",
  "errors": {
    "message": ["The message field is required."]
  }
}
```

#### Canal inv√°lido
```json
{
  "message": "The selected channel is invalid.",
  "errors": {
    "channel": ["The selected channel is invalid."]
  }
}
```

**Valores v√°lidos:** `"whatsapp"`, `"email"`, `"both"` (case-sensitive)

#### Fecha programada en el pasado
```json
{
  "message": "The scheduled at field must be a date after now.",
  "errors": {
    "scheduled_at": ["The scheduled at field must be a date after now."]
  }
}
```

#### filter_json no es un objeto
```json
{
  "message": "The filter json field must be an array.",
  "errors": {
    "filter_json": ["The filter json field must be an array."]
  }
}
```

---

## üîÑ Estados de Campa√±a

Despu√©s de crear, la campa√±a pasa por estos estados:

| Estado | Descripci√≥n |
|--------|-------------|
| `pending` | Creada, en cola para env√≠o |
| `in_progress` | Enviando mensajes |
| `completed` | Todos los mensajes enviados |
| `cancelled` | Cancelada manualmente |
| `failed` | Error en el env√≠o |

---

## üéØ Opciones de `filter_json`

### Opci√≥n 1: Todos los usuarios
```json
"filter_json": {
  "target": "all_users"
}
```
Env√≠a a todos los usuarios del tenant que tengan email/tel√©fono seg√∫n el canal.

### Opci√≥n 2: Asistentes de UNA o VARIAS reuniones
```json
"filter_json": {
  "target": "meeting_attendees",
  "meeting_ids": [15, 18, 20]
}
```
Env√≠a a los asistentes registrados de las reuniones especificadas. Si un asistente particip√≥ en varias reuniones, solo recibe UN mensaje (se eliminan duplicados autom√°ticamente).

**Para una sola reuni√≥n:**
```json
"filter_json": {
  "target": "meeting_attendees",
  "meeting_ids": [15]
}
```

### Opci√≥n 3: Lista personalizada (emails/tel√©fonos espec√≠ficos)
```json
"filter_json": {
  "target": "custom_list",
  "custom_recipients": [
    {
      "type": "email",
      "value": "contacto@example.com",
      "name": "Juan P√©rez"
    },
    {
      "type": "phone",
      "value": "+573001234567",
      "name": "Mar√≠a Gonz√°lez"
    }
  ]
}
```

**Validaciones:**
- `type`: Debe ser `"email"` o `"phone"` (case-sensitive)
- `value`: Email v√°lido o tel√©fono con c√≥digo pa√≠s (ej: +57...)
- `name`: Opcional, nombre del destinatario
- Si `type="email"` pero `channel="whatsapp"` ‚Üí se ignora
- Si `type="phone"` pero `channel="email"` ‚Üí se ignora

### Opci√≥n 4: Sin filtro (default)
```json
// No incluir filter_json
```
Comportamiento igual a `"target": "all_users"`.

---

## üìÖ Formatos de Fecha para `scheduled_at`

### JavaScript/Frontend
```javascript
// Opci√≥n 1: Usar Date ISO string
const scheduledDate = new Date('2025-11-03T08:00:00');
const payload = {
  title: "Mi Campa√±a",
  message: "Mensaje",
  channel: "email",
  scheduled_at: scheduledDate.toISOString() // "2025-11-03T08:00:00.000Z"
};

// Opci√≥n 2: Construir manualmente
const payload = {
  scheduled_at: "2025-11-03T08:00:00Z"
};

// Opci√≥n 3: Agregar horas a fecha actual
const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
tomorrow.setHours(10, 0, 0, 0);
const payload = {
  scheduled_at: tomorrow.toISOString()
};
```

---

## üîó Otros Endpoints Relacionados

### Listar Campa√±as
```
GET /campaigns
```

**Query params opcionales:**
- `?filter[status]=pending` - Filtrar por estado
- `?filter[channel]=email` - Filtrar por canal
- `?sort=-created_at` - Ordenar (usar `-` para descendente)
- `?per_page=20` - Items por p√°gina

### Ver Campa√±a
```
GET /campaigns/{id}
```

### Actualizar Campa√±a (solo si status=pending)
```
PUT /campaigns/{id}
PATCH /campaigns/{id}
```

**Body:** Mismos campos que crear (todos opcionales en update)

### Eliminar Campa√±a
```
DELETE /campaigns/{id}
```

**Restricci√≥n:** No se puede eliminar si status=in_progress

### Enviar Campa√±a Manualmente
```
POST /campaigns/{id}/send
```

Fuerza el env√≠o de una campa√±a pending.

### Cancelar Campa√±a
```
POST /campaigns/{id}/cancel
```

Cancela una campa√±a (excepto si ya est√° completed).

### Ver Destinatarios
```
GET /campaigns/{id}/recipients
```

Lista todos los destinatarios de la campa√±a con su estado de env√≠o.

---

## üí° Tips para Frontend

### 1. Validaci√≥n Previa
```javascript
// Validar antes de enviar
function validateCampaign(data) {
  const errors = {};
  
  if (!data.title || data.title.trim() === '') {
    errors.title = 'T√≠tulo es requerido';
  }
  
  if (!data.message || data.message.trim() === '') {
    errors.message = 'Mensaje es requerido';
  }
  
  if (!['whatsapp', 'email', 'both'].includes(data.channel)) {
    errors.channel = 'Canal inv√°lido';
  }
  
  if (data.channel === 'whatsapp' && data.message.length > 4096) {
    errors.message = 'WhatsApp debe ser menor a 4096 caracteres';
  }
  
  if (data.scheduled_at) {
    const scheduledDate = new Date(data.scheduled_at);
    if (scheduledDate <= new Date()) {
      errors.scheduled_at = 'Fecha debe ser futura';
    }
  }
  
  return errors;
}
```

### 2. Componente de Ejemplo (React/Vue)
```javascript
const [formData, setFormData] = useState({
  title: '',
  message: '',
  channel: 'email',
  filter_json: { target: 'all_users' },
  scheduled_at: null
});

const handleSubmit = async (e) => {
  e.preventDefault();
  
  try {
    const response = await fetch('/campaigns', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(formData)
    });
    
    if (!response.ok) {
      const error = await response.json();
      console.error('Validation errors:', error.errors);
      return;
    }
    
    const result = await response.json();
    console.log('Campaign created:', result.data);
    alert('Campa√±a creada y enviada!');
    
  } catch (error) {
    console.error('Error:', error);
  }
};
```

### 3. Selector de Canal
```javascript
<select value={channel} onChange={e => setChannel(e.target.value)}>
  <option value="email">üìß Email</option>
  <option value="whatsapp">ÔøΩ WhatsApp</option>
  <option value="both">üìßÔøΩ Ambos</option>
</select>
```

### 4. Selector de Audiencia
```javascript
<select value={filterTarget} onChange={e => updateFilter(e.target.value)}>
  <option value="all_users">Todos los usuarios</option>
  <option value="meeting_attendees">Asistentes de reuni√≥n</option>
</select>

{filterTarget === 'meeting_attendees' && (
  <select value={meetingId} onChange={e => setMeetingId(e.target.value)}>
    <option value="">Seleccionar reuni√≥n...</option>
    {meetings.map(m => (
      <option key={m.id} value={m.id}>{m.title}</option>
    ))}
  </select>
)}
```

### 5. Programador de Fecha
```javascript
<input 
  type="datetime-local"
  value={scheduledAt}
  min={new Date().toISOString().slice(0, 16)}
  onChange={e => setScheduledAt(e.target.value)}
/>
```

---

## üé® Casos de Uso Comunes

### Caso 1: Confirmaci√≥n de Asistencia
```json
{
  "title": "Confirma tu Asistencia",
  "message": "¬øAsistir√°s a la reuni√≥n del s√°bado? Responde S√ç o NO.",
  "channel": "whatsapp",
  "filter_json": {
    "target": "meeting_attendees",
    "meeting_ids": [25]
  }
}
```

### Caso 2: Newsletter Mensual
```json
{
  "title": "Newsletter - Octubre 2025",
  "message": "Resumen de actividades del mes...",
  "channel": "email",
  "filter_json": {
    "target": "all_users"
  }
}
```

### Caso 3: Recordatorio Autom√°tico
```json
{
  "title": "Recordatorio 24h antes",
  "message": "Ma√±ana es la reuni√≥n. Te esperamos!",
  "channel": "both",
  "filter_json": {
    "target": "meeting_attendees",
    "meeting_ids": [30]
  },
  "scheduled_at": "2025-11-04T10:00:00Z"
}
```

### Caso 4: Alerta Urgente
```json
{
  "title": "URGENTE: Cambio de Horario",
  "message": "La reuni√≥n de hoy cambia de 3PM a 5PM. Disculpen las molestias.",
  "channel": "both"
}
```

### Caso 5: Campa√±a a L√≠deres Espec√≠ficos (Lista VIP)
```json
{
  "title": "Reuni√≥n de Coordinadores",
  "message": "Los invitamos a la reuni√≥n de coordinaci√≥n este viernes a las 6PM.",
  "channel": "both",
  "filter_json": {
    "target": "custom_list",
    "custom_recipients": [
      {"type": "email", "value": "coordinador.norte@example.com", "name": "Juan L√≥pez"},
      {"type": "phone", "value": "+573001234567", "name": "Mar√≠a P√©rez"},
      {"type": "email", "value": "coordinador.sur@example.com", "name": "Carlos G√≥mez"},
      {"type": "phone", "value": "+573009876543", "name": "Ana Mart√≠nez"}
    ]
  }
}
```

### Caso 6: Seguimiento a M√∫ltiples Reuniones del Mes
```json
{
  "title": "Resumen del Mes",
  "message": "Gracias por participar en nuestras 4 reuniones este mes. Aqu√≠ el resumen de compromisos...",
  "channel": "email",
  "filter_json": {
    "target": "meeting_attendees",
    "meeting_ids": [45, 46, 47, 48]
  }
}
```

---

## üîê Permisos Requeridos

- Usuario debe estar autenticado (JWT token)
- Usuario debe pertenecer a un tenant
- La campa√±a se crea autom√°ticamente para el tenant del usuario

---

## ‚öôÔ∏è Comportamiento del Sistema

1. **Creaci√≥n:** Campaign se crea con status `pending`
2. **Recipients:** Sistema genera autom√°ticamente los destinatarios seg√∫n filtros
3. **Queue:** Campaign se encola para env√≠o (Job as√≠ncrono)
4. **Env√≠o:** 
   - Si `scheduled_at` es NULL ‚Üí env√≠a inmediatamente
   - Si `scheduled_at` tiene fecha ‚Üí programa para esa hora
5. **Tracking:** Sistema actualiza `sent_count` y `failed_count` conforme env√≠a

---

## üì± Integraci√≥n con Reuniones

Para enviar campa√±a despu√©s de crear una reuni√≥n:

```javascript
// 1. Crear reuni√≥n
const meeting = await createMeeting(meetingData);

// 2. Enviar campa√±a a los asistentes
const campaign = await createCampaign({
  title: `Invitaci√≥n: ${meeting.title}`,
  message: `Te invitamos a ${meeting.title} el ${meeting.starts_at}`,
  channel: "both",
  filter_json: {
    target: "meeting_attendees",
    meeting_ids: [meeting.id]
  }
});
```

### Enviar a Asistentes de M√∫ltiples Reuniones

```javascript
// Obtener IDs de reuniones del mes
const meetings = await getMeetingsThisMonth();
const meetingIds = meetings.map(m => m.id);

// Enviar resumen a todos los participantes
const campaign = await createCampaign({
  title: "Resumen del Mes",
  message: "Gracias por participar...",
  channel: "email",
  filter_json: {
    target: "meeting_attendees",
    meeting_ids: meetingIds  // [15, 18, 20, 22]
  }
});
```

### Enviar a Lista Personalizada + Validaci√≥n

```javascript
const customRecipients = [
  { type: "email", value: "juan@example.com", name: "Juan" },
  { type: "phone", value: "+573001234567", name: "Mar√≠a" }
];

// Validar formato de tel√©fonos
const validRecipients = customRecipients.filter(r => {
  if (r.type === 'phone') {
    return /^\+57\d{10}$/.test(r.value); // Validar formato Colombia
  }
  if (r.type === 'email') {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.value);
  }
  return false;
});

const campaign = await createCampaign({
  title: "Invitaci√≥n Especial",
  message: "Los invitamos...",
  channel: "both",
  filter_json: {
    target: "custom_list",
    custom_recipients: validRecipients
  }
});
```

---

## üöÄ Mejores Pr√°cticas

1. **WhatsApp:** Mantener mensajes claros y concisos (m√°ximo 4096 caracteres)
2. **Programaci√≥n:** Dar al menos 1 hora de anticipaci√≥n al programar
3. **Filtros:** Validar que `meeting_ids` existan antes de usar filtro
4. **Canales:** Usar `both` solo cuando sea realmente necesario
5. **Testing:** Probar primero con pocos destinatarios
6. **Formato:** WhatsApp soporta formato markdown (*negrita*, _cursiva_, ~tachado~)

---

## üìû Soporte

Para dudas sobre implementaci√≥n, referirse a:
- `app/Http/Controllers/CampaignController.php`
- `app/Services/CampaignService.php`
- `app/Models/Campaign.php`
